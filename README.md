# Supabase + Streamlit + GitHub Actions で作る「顧客管理アプリ」開発ログ

「Supabase + Streamlit + GitHub Actions (すべて無料)」を使って「シンプルな顧客情報のCRUDアプリ」をデプロイまでやります。
※SupabaseとGitHub Actionsは初めて使うことを想定しています。

### アプリの要件
シンプルな登録・表示機能に加え、サーバーレスな運用を考慮した以下の機能を実装しました。
* **登録**: 顧客名、関与日、事業内容を入力し、Supabaseに保存。
* **自動生成**: 呼び出しID（UUID）と作成日時はデータベース側で自動生成。
* **表示**: 呼び出しIDを使って顧客情報を照会。
* **自動削除**: 登録から24時間以上経過したデータは、GitHub Actionsを使って自動的に削除（Supabaseの一時停止防止や容量節約のため）。

今回は**「GitHubのブラウザ画面からのドラッグ＆ドロップ」**を多用し、エディタ等でのコマンドライン操作を行わなくても完結するように手順を組んでいます。

---

## 全体の流れ
1.  **Supabase**: データベースとテーブルを作成する
2.  **ローカル**: Pythonファイルと設定ファイルを作成する
3.  **動作確認**: 仮想環境を作ってライブラリを入れ、ローカルでアプリをテストする（※DBはクラウド上のSupabaseを使います。PCにPostgreSQLがインストールされている必要はありません。）
4.  **GitHub**: ファイルをアップロードし、自動削除の設定（Actions）を行う
5.  **Streamlit Cloud**: GitHubと連携してアプリを公開する

---

## 1. Supabaseの準備（データベース）
まず、データを保存する箱を作ります。

1. [Supabase](https://supabase.com/) にアクセスし、アカウントを作成します（**GitHubアカウント連携**で行うとスムーズでおすすめです）。
2. **Organization（組織）の作成**:
    * 画面の指示に従い組織を作成します（Planは「Free」でOK）。
3. **Project（プロジェクト）の作成**:
    * 「Create a new project」画面で以下を設定します。
    * **Region**: 必ず **「Northeast Asia (Tokyo)」** を選択してください（デフォルトはシンガポール等になっていることがあります）。
    * **Database Password**: **この画面でしか表示されない**ため、必ず「Copy」して手元に控えてから「Create new project」を押してください。
    * 構築完了まで数分待ちます。
4. **テーブルの作成**:
    * 左メニューの **SQL Editor**（`>_` のようなアイコン）を開きます。
    * 以下のSQLを貼り付けて「Run」を押してください。（これでテーブルが一発で作れます）

```sql
-- 顧客情報テーブル
create table customers (
  id bigint generated by default as identity primary key,
  call_id uuid default gen_random_uuid() not null, -- 呼び出しID (自動生成)
  created_at timestamp with time zone default timezone('utc'::text, now()) not null, -- 作成日時 (自動生成)
  customer_name text not null, -- 顧客名
  engagement_date date, -- 関与日
  business_desc text -- 事業内容
);

-- 重要: 初めてなのでRow Level Security(RLS)は一旦無効化してアクセスしやすくします
alter table customers disable row level security;
```

5. **APIキーの取得**:
    * 左メニュー最下部の **Project Settings** (歯車アイコン) → **API** を開きます。
    * 以下の2つをメモ帳に控えてください。
        * **Project URL**: `https://...supabase.co` から始まるURL
        * **Project API keys**: **`Publishable key`** と書かれている値（`default` の右側にあるコピーボタンを使用）。
          * ※注意: 以前は `anon` / `public` と表記されていましたが、現在は `Publishable key` という名称になっています。

---

## 2. Pythonコードの作成
ローカルのフォルダに以下の3つのファイルを作成してください。

### ① `requirements.txt`
必要なライブラリを指定します。

```text
streamlit
supabase
```

### ② `app.py`
Streamlitアプリ本体です。

```python
import streamlit as st
from supabase import create_client, Client
import datetime
import os

# --- 設定と接続 ---
# Streamlit Cloud上では st.secrets、ローカルでは .streamlit/secrets.toml から読み込む
url = st.secrets["SUPABASE_URL"]
key = st.secrets["SUPABASE_KEY"]
supabase: Client = create_client(url, key)

st.title("顧客管理システム")

# --- タブで機能を分ける ---
tab1, tab2 = st.tabs(["📝 顧客登録", "🔍 顧客表示"])

# --- タブ1: 顧客登録 ---
with tab1:
    st.header("新規登録")
    
    with st.form("register_form"):
        name = st.text_input("顧客名")
        date = st.date_input("関与日", value=datetime.date.today())
        desc = st.text_area("事業内容 (空欄可)")
        
        submitted = st.form_submit_button("顧客登録ボタン")
        
        if submitted:
            if not name:
                st.error("顧客名は必須です。")
            else:
                # Supabaseへのデータ送信 (UUIDと作成日時はDB側で自動生成)
                data = {
                    "customer_name": name,
                    "engagement_date": str(date),
                    "business_desc": desc
                }
                
                try:
                    response = supabase.table("customers").insert(data).execute()
                    
                    # 登録されたデータのUUIDを取得
                    new_uuid = response.data[0]['call_id']
                    
                    st.success("登録完了！")
                    st.write("以下の呼び出しIDを控えてください（コピーボタン推奨）")
                    
                    # コピーしやすいようにコードブロックで表示
                    st.code(new_uuid, language="text")
                    
                except Exception as e:
                    st.error(f"エラーが発生しました: {e}")

# --- タブ2: 顧客表示 ---
with tab2:
    st.header("情報照会")
    
    search_uuid = st.text_input("呼び出しID (UUID) を入力")
    search_btn = st.button("顧客表示")
    
    if search_btn and search_uuid:
        try:
            # Supabaseから検索
            response = supabase.table("customers").select("*").eq("call_id", search_uuid).execute()
            
            if response.data:
                record = response.data[0]
                
                # --- 日時変換処理 (UTC -> JST) ---
                # DBから取得したUTC日時文字列をdatetimeオブジェクトへ
                dt_utc = datetime.datetime.fromisoformat(record['created_at'])
                # 9時間足してJSTへ変換
                dt_jst = dt_utc.astimezone(datetime.timezone(datetime.timedelta(hours=9)))
                # 読みやすい形式に整形 (例: 2026年01月28日 10時23分)
                formatted_date = dt_jst.strftime('%Y年%m月%d日 %H時%M分')
                
                st.markdown("### 顧客情報")
                st.write(f"**顧客名:** {record['customer_name']}")
                st.write(f"**関与日:** {record['engagement_date']}")
                st.write(f"**事業内容:** {record['business_desc']}")
                st.write(f"**作成日時:** {formatted_date}")
            else:
                st.warning("該当する顧客情報が見つかりませんでした。")
                
        except Exception as e:
            st.error(f"検索エラー: {e}")
```

### ③ `cleanup.py`
GitHub Actionsで定期実行させる「お掃除用」のPythonファイルです。`app.py`とは別に、裏側で動くプログラムです。

```python
import os
import datetime
from supabase import create_client, Client

# GitHub ActionsのSecretsから環境変数を読み込む
url = os.environ.get("SUPABASE_URL")
key = os.environ.get("SUPABASE_KEY")

if not url or not key:
    raise ValueError("環境変数 SUPABASE_URL または SUPABASE_KEY が設定されていません")

supabase: Client = create_client(url, key)

def delete_old_records():
    # 現在時刻から24時間前を計算 (UTC)
    time_threshold = datetime.datetime.now(datetime.timezone.utc) - datetime.timedelta(hours=24)
    threshold_str = time_threshold.isoformat()
    
    print(f"{threshold_str} 以前のデータを削除します...")

    try:
        # created_at が 24時間前より小さい(lt: less than)データを削除
        response = supabase.table("customers").delete().lt("created_at", threshold_str).execute()
        
        # response.data は削除された行のリスト
        deleted_count = len(response.data)
        print(f"削除完了: {deleted_count} 件のデータを削除しました。")
        
    except Exception as e:
        print(f"エラーが発生しました: {e}")

if __name__ == "__main__":
    delete_old_records()
```

---

## 3. ローカルでの動作確認
自分のPCでアプリを動かしてテストするために、仮想環境を構築し、設定ファイルを作ります。
※ここで登録したデータは、実際にクラウド上のSupabaseに保存されます。

### 1. 仮想環境の作成とライブラリのインストール
`app.py` があるフォルダ階層にて、VS Code上のターミナル（PowerShell等）で以下のコマンドを実行し、Pythonの仮想環境を作って必要なライブラリ（`requirements.txt` の中身）を入れます。

```powershell
# 1. 仮想環境を作成 (.venvというフォルダができます)
py -m venv .venv

# 2. 仮想環境を有効化 (先頭に (.venv) と表示されればOK)
.venv\Scripts\Activate.ps1

# 3. 必要なライブラリを一括インストール
pip install -r requirements.txt
```

### 2. APIキーの設定
1. `app.py` があるフォルダの中に、新しいフォルダ **`.streamlit`** を作成します（先頭のドットを忘れずに）。
2. そのフォルダの中に、**`secrets.toml`** というファイルを作成します。
3. `secrets.toml` に、先ほど取得したSupabaseのキーを以下の形式で記述します。


```toml
SUPABASE_URL = "https://あなたのURL.supabase.co"
SUPABASE_KEY = "あなたのPublishableKey"
```

### 3. アプリの起動
準備ができたら、以下のコマンドでアプリを起動します。

```powershell
streamlit run app.py
```
* ブラウザが自動で開き、アプリが表示されれば成功です！
* **重要**: この `secrets.toml` ファイルには重要なキーが含まれるため、**GitHubにはアップロードしないでください。**（今回はドラッグ＆ドロップでファイルを選択するため、このファイルをアップロードしないように気をつければOKです）

---

## 4. GitHubへのアップロードと設定
ここがデプロイの肝です。

### 1. リポジトリ作成とアップロード
1.  GitHubにログインし、「New Repository」を作成します（例: `supabase-streamlit-github-actions-customer-app-XXXX`）。Choose visibillityは、「Public」を選択する。
2.  作成したリポジトリの画面で「uploading an existing file」を選択します。
3.  **`requirements.txt`, `app.py`, `cleanup.py` の3つだけ**をドラッグ＆ドロップして、「Commit changes」を押します。
    * ※注意: `.venv` フォルダ、`.streamlit` フォルダ、`secrets.toml` はアップロードしません。

### 2. GitHub Actionsの設定（自動削除の設定）
1.  リポジトリの **「Actions」** タブをクリック → **「set up a workflow yourself」** をクリック。
2.  ファイル名（`main.yml`など）はそのままで、以下の内容をコピーして貼り付けます。

```yaml
name: Daily Cleanup

on:
  schedule:
    # 毎日 日本時間の朝9時 (UTC 0:00) に実行
    # ※ちなみにテストしたい場合は '*/5 * * * *' にすると5分ごとに動きます。なお「Actions」では手動でテスト実行も可能(後述)。
    - cron: '0 0 * * *'
  workflow_dispatch: # 手動実行ボタンも有効化

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリの取得
        uses: actions/checkout@v3

      - name: Pythonのセットアップ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ライブラリのインストール
        run: |
          pip install supabase

      - name: 削除スクリプトの実行
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python cleanup.py
```
3.  「Commit changes」を押して保存します。

※なお、「さっき貼り付けたYAMLファイルの中身を確認・修正したい」場合は、リポジトリの「Code」タブからファイルを探します。().github/workflows → main.yml)


### 3. GitHub Secretsの設定
GitHub ActionsがSupabaseに接続するためのパスワード設定です。

1.  リポジトリ画面上部の **Settings** → 左メニューの **Secrets and variables** → **Actions** をクリック。
2.  「New repository secret」ボタンを押して、2つ登録します。
    * Name: `SUPABASE_URL` / Secret: (SupabaseのURL)
    * Name: `SUPABASE_KEY` / Secret: (SupabaseのKey)

これで、毎日決まった時間に `cleanup.py` が実行され、古いデータが消えます！

### 4. (飛ばしてOK)「Actions」での手動テスト（Run workflow）
「Actions」では手動テスト（Run workflow）が可能です。

1.  リポジトリの **「Actions」** タブをクリック
2.  左側のメニューにある 「Daily Cleanup」 をクリックしてください。
3.  画面右側に 「Run workflow ▾」 というボタンをクリックし、表示される緑色の 「Run workflow」 ボタンをクリックする
4.  数秒〜数十秒待ってブラウザを更新すると、リストに「Daily Cleanup」という行が増え、黄色いクルクル（実行中）→ 緑色のチェックマーク（✅） になれば成功です！


---

## 5. Streamlit Cloudへのデプロイ
最後にアプリを表側に公開します。

1.  [Streamlit Cloud](https://streamlit.io/cloud) にログインします。
2.  「Create app」を押し、先ほどのGitHubリポジトリを選択します。
3.  Main file pathにて「app.py」を選択します。
4.  **Advanced settings** をクリックします。
5.  ここにSupabaseの鍵情報を入力します（`app.py` が使うため）。
    * ※ローカルで作った `secrets.toml` の中身をコピペすればOKです。

```toml
SUPABASE_URL = "あなたのSupabaseのURL"
SUPABASE_KEY = "あなたのSupabaseのKey"
```

5.  「Deploy!」ボタンを押します。

---

## 完成！
これで以下の機能を持つアプリがWeb上に公開されました。

1.  **登録**: Streamlit画面から入力 → Supabaseに保存（UUID自動発行）。
2.  **表示**: UUIDで検索 → データを表示。
3.  **自動化**: GitHub Actionsが定期的に起動し、Pythonスクリプト経由で「24時間以上前のデータ」をSupabaseから削除。

### 🚀 完走した方へ：この構成が持つ可能性

「Supabase + Streamlit + GitHub Actions」を使った完全無料・サーバーレスなアプリ開発プロジェクト、完遂おめでとうございます！

この構成を手に入れたことで、あなたの技術的な「武器」は大きく広がりました。

1.  **Supabase (PostgreSQL) の力**
    * 単なるExcelやCSV保存とは異なり、**本格的なリレーショナルデータベース(RDBMS) + SQL** が手に入りました。
    * これにより、数万件のデータ管理、複雑な検索、他のアプリとのデータ連携が可能になります。
    * テーブル同士を組み合わせてより複雑な要件に対応できるプログラミングが可能です。
    * 具体的には顧客テーブルと対応履歴テーブルを別々に管理して紐付ける（JOIN）など、**データの重複を排除した、保守性の高い本格的なシステム設計**が可能になります。

2.  **GitHub Actions の力**
    * 自分のPCを立ち上げていなくても、**クラウド上でプログラムを自動実行できる仕組み** を手に入れました。
    * 「毎日決まった時間（スケジュールトリガー）」や「コードを更新した時（プッシュトリガー）」に、Pythonスクリプトを自動で動かせます。

**✨ これらを組み合わせると、こんなことができます**

* **自動データ収集アプリ**: 毎日特定のサイトをスクレイピングし、価格やニュースをSupabaseに蓄積し続ける。
* **業務自動化ツール**: データベース内の顧客情報の期限を毎日チェックし、期日が迫った顧客がいればChatworkやSlack、LINE、Discordに自動通知を送る。
* **ダッシュボード**: 蓄積されたデータをStreamlitでグラフ化し、リアルタイムで経営数値を可視化する。

これらはすべて、**サーバー代0円**で運用可能です。ぜひこの構成をベースに、自分だけの業務効率化ツールを開発してみてください！
